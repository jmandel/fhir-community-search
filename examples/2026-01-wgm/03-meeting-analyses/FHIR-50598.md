# FHIR-50598: Change _outputFormat Handling So That Behavior Is Less Dependent on Server Support

## Issue Overview

This issue identifies a problematic interaction between the `_outputFormat` parameter and the two async patterns in FHIR: Async Bulk (ndjson-based) and Async Interaction (bundle-based). The behavior of `_outputFormat` changes depending on what a server supports, creating unpredictable behavior for clients.

**The Problem:**
- If a server **only** supports Async Bulk: `_outputFormat` is optional; omitting it triggers Async Bulk (defaults to `application/fhir+ndjson`)
- If a server supports **both** Async Bulk and Async Interaction: omitting `_outputFormat` now triggers Async Interaction instead

This means a client that was successfully using Async Bulk without specifying `_outputFormat` will suddenly get different behavior if the server later adds Async Interaction support â€“ a silent breaking change caused by an unrelated server enhancement.

The submitter requests:
1. A way to unambiguously request Async Interaction over Async Bulk
2. Consistent behavior when `_outputFormat` is omitted, regardless of server capabilities

## Current State

The FHIR async specification has two patterns:

**Async Bulk (ndjson):**
- Returns data as newline-delimited JSON files
- Designed for large data exports
- Uses `_outputFormat=application/fhir+ndjson`

**Async Interaction (bundle):**
- Returns standard FHIR bundles
- Designed for long-running operations that return normal FHIR responses
- No specific `_outputFormat` value defined

The spec uses `_outputFormat` as a disambiguation mechanism, but the logic is asymmetric and server-capability-dependent.

## Stakeholder Perspectives

**James Jahns** (Reporter):
- Identified the behavioral inconsistency
- Concerned about clients breaking when servers add new capabilities
- Wants unambiguous request mechanisms

**Gino Canessa** (Comment):
- Agrees this is a problem
- Notes that clients using implicit ndjson will break if server adds generic async support
- Explains the **intention** of the authors:
  - Operations are generally expected to use one style of async
  - Text around `_outputFormat` for disambiguation was written in one direction only
  - Suggests removing the disambiguation text as "more problematic than it is worth"
- Proposes: Define an extension for `OperationDefinition` to identify async expectations (e.g., `bulk-data` vs `async-interaction`)

**From Zulip Discussion (implementers > Async interaction pattern):**

**Josh Mandel**: 
- Discussed limitations of current async bundle pattern
- Proposed simplified async pattern with cleaner semantics
- Draft at https://hackmd.io/@jmandel/async-pattern-simplified

**Michele Mottini**: 
- Using async patterns in DaVinci PDex for bulk member match
- Concerned about proposed changes being breaking for R4 implementations
- "I propose we leave things as they are in R5 - it is not nice but it works"

**Nikolai Ryzhikov**: 
- Detailed suggestions for improving HTTP semantics (303 See Other, etc.)
- Proposes generalizing async pattern so R5 becomes a special case

**Kevin Mayfield**: 
- NHS England used this pattern
- Now favoring event patterns (FHIR Workflow) instead

## Related Issues & Discussions

- [Async Bulk Specification](https://hl7.org/fhir/6.0.0-ballot3/async-bulk.html)
- [Async Bundle Pattern](https://build.fhir.org/async-bundle.html)
- [Zulip: implementers > Async interaction pattern](https://chat.fhir.org/#narrow/stream/implementers/topic/Async%20interaction%20pattern) - Detailed discussion from August-November 2025
- [Josh Mandel's Simplified Async Proposal](https://hackmd.io/@jmandel/async-pattern-simplified)
- DaVinci PDex bulk member match operation

## Technical Considerations

1. **Silent Breaking Change**: The current design causes client behavior to change when servers add capabilities, without any error or warning.

2. **Operation Definition Gap**: There's no standard way in `OperationDefinition` to declare which async pattern an operation uses.

3. **R4 Compatibility**: DaVinci PDex and other IGs are using async patterns in R4; changes need to consider backward compatibility.

4. **Content Negotiation**: The issue is fundamentally about content negotiation, but `_outputFormat` is overloaded to also select async patterns.

5. **Polling vs Final Response**: The async pattern discussion has expanded to include HTTP semantics for polling (200 vs 303, inline results, etc.).

6. **Grouping as "MovingToGuide"**: This issue is tagged for potentially moving to an IG rather than core spec.

## Potential Courses of Action

### Option A: Remove _outputFormat Disambiguation Text
- **Description**: Remove the text that makes `_outputFormat` responsible for choosing between async patterns; let operations declare their pattern
- **Pros**: Simpler; addresses Gino's stated author intention; removes problematic interaction
- **Cons**: Doesn't provide a new disambiguation mechanism; may affect existing implementations
- **Impact**: Non-substantive clarification/removal

### Option B: Define _outputFormat Values for Async Interaction
- **Description**: Define specific `_outputFormat` values that explicitly request Async Interaction pattern (e.g., `application/fhir+json`)
- **Pros**: Provides explicit client control; symmetric with Async Bulk
- **Cons**: May conflict with existing content negotiation semantics; adds complexity
- **Impact**: Compatible, substantive clarification

### Option C: Add OperationDefinition Extension for Async Pattern
- **Description**: Define an extension on `OperationDefinition` to declare which async pattern an operation uses
- **Pros**: Clear declaration; operation-specific; supports discovery
- **Cons**: Doesn't help at request time; still need runtime disambiguation
- **Impact**: Compatible, substantive extension

### Option D: Make Behavior Consistent Regardless of Server Capabilities
- **Description**: Define that omitting `_outputFormat` always triggers a specific default (e.g., Async Interaction if available, else Async Bulk)
- **Pros**: Predictable behavior; clients know what to expect
- **Cons**: May be breaking for some current implementations; arbitrary choice
- **Impact**: Potentially breaking clarification

### Option E: Defer to Async Pattern Simplification Effort
- **Description**: Let Josh Mandel's simplified async pattern work resolve this as part of a broader redesign
- **Pros**: Holistic solution; addresses multiple async issues together
- **Cons**: Delays resolution; unclear timeline; broader scope
- **Impact**: Deferred

## Questions for the Workgroup

1. Should `_outputFormat` be removed from the async pattern disambiguation role entirely?

2. Is it acceptable for server capability additions to silently change client behavior?

3. Should operations be required to declare their async pattern in `OperationDefinition`?

4. How should R4 implementations (like DaVinci PDex) be considered in any changes?

5. Should this issue be coordinated with the broader async pattern simplification discussion?

6. Is the "MovingToGuide" grouping appropriate, or should this remain in core?

## References

- [FHIR-50598 Jira Issue](https://jira.hl7.org/browse/FHIR-50598)
- [Async Bulk Specification](https://hl7.org/fhir/6.0.0-ballot3/async-bulk.html)
- [Async Bundle Pattern](https://build.fhir.org/async-bundle.html)
- [Zulip: Async interaction pattern](https://chat.fhir.org/#narrow/stream/implementers/topic/Async%20interaction%20pattern)
- [Simplified Async Proposal](https://hackmd.io/@jmandel/async-pattern-simplified)
- [DaVinci PDex Bulk Exchange](https://build.fhir.org/ig/HL7/davinci-epdx/payertopayerbulkexchange.html)
