# FHIR-54078: Type Factory functionality not ready for normative and should be moved to incubator

## Issue Overview

This ballot comment from Brian Postlethwaite argues that the `%factory` Type Factory functions in FHIRPath are not ready for normative status and should be moved to an incubator IG. The key concerns are:

1. **Insufficient implementation experience**: Was draft/maturity-0 in R5
2. **Duplicates approved FHIRPath functionality**: FHIR-33044 approved CQL-style constructor syntax for FHIRPath, making `%factory` redundant
3. **Design inconsistencies**: Non-fluent style, inconsistent parameter handling, confusing documentation

The commenter provides detailed feedback on each function and proposes fluent alternatives.

## Current State

The `%factory` Type Factory provides functions for creating FHIR types in FHIRPath:

**Specific type constructors:**
- `%factory.{primitive}(value, extensions)` - Create any primitive
- `%factory.Extension(url, value)` - Create an extension
- `%factory.Identifier(system, value, use, type)` - Create an identifier
- `%factory.HumanName(family, given, prefix, suffix, text, use)` - Create a name
- `%factory.ContactPoint(system, value, use)` - Create a contact point
- `%factory.Address(line, city, state, postalCode, country, use, type)` - Create an address
- `%factory.Quantity(system, code, value, unit)` - Create a quantity
- `%factory.Coding(system, code, display, version)` - Create a coding
- `%factory.CodeableConcept(coding, text)` - Create a codeable concept

**Generic constructors:**
- `%factory.create(type)` - Create any type
- `%factory.withProperty(object, property, value)` - Add property to object

**Meanwhile, FHIRPath has approved (FHIR-33044) a CQL-style constructor syntax:**
```
Coding { system: 'http://example.org', code: 'test' }
```

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite):** Extensive critique:

- Factory functions duplicate the new FHIRPath instance selector syntax (FHIR-33044)
- The `%factory.primitive` and `%factory.create` should be removed (now covered by new syntax)
- Functions are not fluent-style like most FHIRPath
- Inconsistent examples and documentation formatting
- Parameter optionality documentation is confusing
- The curly braces in `%factory.{primitive}` could be confused with empty collection syntax `{}`

**Proposed fluent alternatives:**
- `createCoding(sys, code, display, version)`
- `createCodeableConcept(coding, text)`
- `createIdentifier(system, value, [use], [type])`
- `createQuantity(system, code, value, unit)`
- `withExtension(url, value)` - Fluent form returning copy with extension
- `withProperty(identifier, value)` - Fluent form returning copy with property
- `toCoding(codedString)` - Convert pipe-separated string to Coding

**Zulip Discussion ("Object creation" thread):**

- **Paul Lynch (fhirpath.js)**: "fhirpath.js implements the %factory approach. The new syntax... is definitely more concise and readable"
- **Grahame Grieve**: "I'm not a fan of anonymous types" and "I'm suspicious of introducing new syntax at this point"
- **Bryn Rhodes**: CQL engines already support the constructor syntax; "list selector would be great: { 'a', 'b' }"
- **Yury Sedinkin**: Supports the new syntax but notes fluent functions still needed for copying objects with modifications

## Related Issues & Discussions

- **FHIR-33044** (Resolved - Persuasive): "Support constructor syntax" - Approved CQL-style instance selector for FHIRPath
- [FHIRPath CI Build with instance selector](https://build.fhir.org/ig/HL7/FHIRPath/branches/BP-FHIR-44774/index.html#instance-selector)

**Zulip:**
- #fhirpath > "Object creation" - Active discussion on factory vs constructor approaches
- #fhirpath > "%factory.Extension -- specifying type for value[x]?" - Implementation questions

## Technical Considerations

1. **Redundancy**: With FHIR-33044 approved, the `%factory.create` and `%factory.primitive` become redundant with the constructor syntax:
   ```
   // Factory
   %factory.Coding('http://loinc.org', '1234-5', 'Test')
   
   // Constructor (FHIR-33044)
   Coding { system: 'http://loinc.org', code: '1234-5', display: 'Test' }
   ```

2. **Implementation Status**: fhirpath.js implements %factory. CQL engines support constructor syntax. Limited overlap.

3. **Fluent Pattern**: FHIRPath is predominantly fluent. The `%factory.xxx()` pattern is an outlier.

4. **Modification Use Case**: The `withProperty`/`withExtension` pattern for modifying objects is useful and not addressed by constructors alone.

5. **Documentation Issues**: Current documentation has formatting inconsistencies, confusing parameter optionality rules, and missing examples.

6. **Normative Lock-in**: Making `%factory` normative while constructor syntax is also being added creates long-term maintenance of two patterns.

## Potential Courses of Action

### Option A: Move %factory to Incubator
- **Description**: Remove all `%factory` functions from normative FHIRPath spec. Move to incubator IG. Keep focus on constructor syntax.
- **Pros**:
  - Avoids normative lock-in of redundant functionality
  - Allows design cleanup in incubator
  - Constructor syntax (FHIR-33044) provides core capability
- **Cons**:
  - fhirpath.js users would lose normative backing
  - Specific type helpers (Coding, Identifier) are convenient
- **Impact**: Non-compatible (removal)

### Option B: Keep Specific Type Helpers, Remove Generic
- **Description**: Keep convenient specific constructors (`%factory.Coding`, `%factory.Identifier`, etc.) but remove generic `%factory.create` and `%factory.primitive` that overlap with constructor syntax.
- **Pros**:
  - Maintains useful shortcuts
  - Removes redundancy with constructor syntax
  - Partial backward compatibility
- **Cons**:
  - Still maintains non-fluent pattern
  - Doesn't address design issues
- **Impact**: Partially non-compatible

### Option C: Redesign as Fluent Functions
- **Description**: Replace `%factory.xxx()` with fluent `createXxx()` functions as proposed. Keep `withProperty()`/`withExtension()` as fluent modifiers.
- **Pros**:
  - Consistent with FHIRPath design
  - Cleaner syntax
  - Addresses modification use case
- **Cons**:
  - Breaking change for existing users
  - Significant redesign work
- **Impact**: Non-compatible

### Option D: Fix Documentation Only
- **Description**: Address documentation issues (examples, formatting, parameter clarity) without structural changes.
- **Pros**:
  - Minimal disruption
  - Addresses immediate usability
- **Cons**:
  - Locks in redundant/inconsistent design
  - Still have two creation patterns
- **Impact**: Non-substantive

### Option E: Define Clear Roles for Factory vs Constructor
- **Description**: Keep both but clearly document:
  - Constructor syntax for general object creation
  - `%factory` for convenience functions with sensible defaults
  - Deprecation path for overlapping functions
- **Pros**:
  - Maintains compatibility
  - Provides guidance
- **Cons**:
  - Two patterns is confusing
  - Technical debt
- **Impact**: Non-substantive (guidance)

## Questions for the Workgroup

1. **Redundancy**: With FHIR-33044 approved, is there still a need for `%factory` functions?

2. **Implementation Reliance**: How many implementations depend on `%factory`? Would removal be disruptive?

3. **Convenience vs Consistency**: Is the convenience of `%factory.Coding(...)` worth the inconsistency with constructor syntax?

4. **Modification Pattern**: The `withProperty`/`withExtension` use case for modifying objects - is this important enough to keep/develop?

5. **Normative Bar**: Does `%factory` meet the implementation experience bar for normative status?

6. **Timing**: Should we wait for constructor syntax (FHIR-33044) to be published before deciding on `%factory`?

## References

- [FHIRPath Type Factory](https://build.fhir.org/fhirpath.html#factory)
- [Jira Issue FHIR-54078](https://jira.hl7.org/browse/FHIR-54078)
- [FHIR-33044: Support constructor syntax](https://jira.hl7.org/browse/FHIR-33044)
- [FHIRPath Instance Selector Draft](https://build.fhir.org/ig/HL7/FHIRPath/branches/BP-FHIR-44774/index.html#instance-selector)
- [Zulip: Object creation thread](https://chat.fhir.org/#narrow/stream/fhirpath/topic/Object%20creation)
- Section 2.1.9.3 of FHIR Core Specification
