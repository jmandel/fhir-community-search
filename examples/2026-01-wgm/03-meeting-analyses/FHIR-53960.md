# FHIR-53960: Additional Functions - Inconsistent error handling patterns

## Issue Overview

Brian Postlethwaite identifies inconsistent error handling patterns across FHIRPath functions in FHIR's additional functions section. Some functions return empty collections on error/invalid input, while others throw errors. This inconsistency makes it difficult for implementers to build robust FHIRPath engines and for users to write reliable expressions.

The issue also notes that FHIR's implementation deviates from core FHIRPath specification behavior regarding singleton-only functions, and that the `weight` function doesn't declare whether it requires singleton input.

This is a specification consistency issue that affects both implementer experience and expression reliability.

## Current State

**Functions that return empty on error/invalid input:**
- `hasValue`, `getValue`, `toString`
- `memberOf`, `subsumes`, `subsumedBy`
- `htmlChecks`, `conformsTo`
- `elementDefinition`, `slice`
- `resolve`, `ofType`
- All `%server` functions (read, create, update, delete, search, patch, validate, transform, everything, apply)

**Functions that throw errors:**
- `checkModifiers` - throws if modifiers found
- `%factory` functions - noted as returning "or an error" for primitives

**Core FHIRPath deviation:**
The FHIRPath core specification states that singleton-only functions should throw when given multiple values. FHIR's implementation returns empty instead. This deviation is not explicitly documented or justified.

**Undocumented behavior:**
- `weight` function doesn't declare if it requires singleton input

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite)**: As a FHIRPath engine implementer, Brian needs consistent rules to implement. The current inconsistency means he must make case-by-case decisions that may not match other implementations.

No other comments on this issue yet.

## Related Issues & Discussions

- **FHIR-53951**: Documentation gaps including missing cardinality specifications
- **FHIR-53953**: Remote interaction error handling
- **FHIR-53954**: %factory/%server maturity concerns
- **FHIR-54074**: %server error handling critique
- **FHIR-54078**: %factory error handling notes

**Zulip**: The #fhirpath stream has various discussions about FHIRPath error handling in validation contexts, suggesting this is a common implementer pain point.

## Technical Considerations

1. **Fail-safe vs fail-fast**: Return-empty is "fail-safe" (expression continues), throw-error is "fail-fast" (immediate feedback). Different use cases favor different approaches:
   - Validation: may want fail-fast to identify problems
   - Data extraction: may want fail-safe to handle missing data gracefully
   - Search parameters: fail-safe prevents broken searches

2. **Debugging difficulty**: Return-empty hides errors, making debugging difficult. A trace mechanism could help.

3. **Core FHIRPath alignment**: The deviation from core FHIRPath singleton behavior should be documented and justified, or the implementation should be changed.

4. **Backward compatibility**: Any change to error handling behavior is potentially breaking for existing expressions that depend on current behavior.

5. **checkModifiers special case**: This function's error-throwing behavior is intentional (it's meant to halt processing when modifiers are found), but the inconsistency with other functions is confusing.

6. **Remote function errors**: Functions involving remote calls (%server, terminology functions) have additional failure modes that need consistent handling.

## Potential Courses of Action

### Option A: Standardize on Return-Empty with Documentation
- **Description**: Document that all FHIR FHIRPath functions return empty on error, with explicit exceptions noted
- **Pros**: 
  - Consistent, predictable behavior
  - Fail-safe for most use cases
  - Minimal breaking changes
- **Cons**: 
  - Hides errors, complicates debugging
  - `checkModifiers` becomes an exception needing justification
  - Doesn't address core FHIRPath deviation
- **Impact**: Non-substantive (documentation clarification)

### Option B: Standardize on Throw-Error with Opt-In Safe Wrappers
- **Description**: Functions throw on error by default; provide `.safe()` or similar wrapper that catches and returns empty
- **Pros**: 
  - Aligns with core FHIRPath singleton behavior
  - Fail-fast aids debugging
  - Gives users control over behavior
- **Cons**: 
  - Breaking change for existing expressions
  - Adds complexity
  - Different from current R5 behavior
- **Impact**: Non-compatible (behavioral change)

### Option C: Document Current Behavior + Trace Support
- **Description**: Document current inconsistent behavior explicitly; add `trace()` or similar for error visibility
- **Pros**: 
  - No breaking changes
  - Improves debuggability
  - Honest about current state
- **Cons**: 
  - Doesn't fix the underlying inconsistency
  - Implementers still face ambiguity for new functions
- **Impact**: Non-substantive + Compatible (new trace function)

### Option D: Context-Dependent Error Handling
- **Description**: Define error handling behavior per context (validation vs query vs extraction)
- **Pros**: 
  - Appropriate behavior for each use case
  - Acknowledges real-world complexity
- **Cons**: 
  - Complex specification and implementation
  - More burden on implementers
  - May cause confusion
- **Impact**: Compatible, substantive

## Questions for the Workgroup

1. Should FHIR FHIRPath functions have consistent error handling behavior, or is function-by-function variation acceptable?

2. What is the justification for deviating from core FHIRPath's singleton-only function behavior?

3. Is `checkModifiers` intentionally different, and if so, should that be explicit?

4. Should `weight` be documented as singleton-only?

5. Would a `trace()` or error-capture mechanism address debugging concerns?

6. How should this interact with the remote interaction documentation (FHIR-53953)?

## References

- [FHIR-53960 Jira Issue](https://jira.hl7.org/browse/FHIR-53960)
- [FHIRPath Specification Page](https://hl7.org/fhir/6.0.0-ballot4/fhirpath.html)
- [Core FHIRPath Specification](http://hl7.org/fhirpath/)
- Related: [FHIR-53951](https://jira.hl7.org/browse/FHIR-53951), [FHIR-53953](https://jira.hl7.org/browse/FHIR-53953)
