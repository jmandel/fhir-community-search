# FHIR-54062: Rework startOffset/endOffset constraint

## Issue Overview

This ballot comment from Hayden Bader (Epic) identifies that the current constraints for `startOffset` and `endOffset` in the `Timing.repeat` datatype are underspecified and could lead to confusing or ambiguous dosage instructions.

The current constraints (tim-11 and tim-12) only require that `frequency` be present and greater than 1 when using offsets:
- `startOffset.exists() implies (frequency > 1)`
- `endOffset.exists() implies (frequency > 1)`

However, a real-world dosage example demonstrates that both `period` and `frequency` are semantically important for offsets to make sense. The example shows a 28-day cycle where medication is taken for 21 days followed by 7 days off:
```
timing.repeat:
  endOffset = 7d
  frequency: 21
  period: 28
  periodUnit: d
```

The concern is that without proper constraints, a frequency of 11 or 14 in the above example would create confusing, potentially meaningless dosing instructions. The offset should have a clear mathematical relationship with the period and frequency to be unambiguous.

## Current State

The Timing.repeat structure in R6 includes:
- `startOffset` (Duration) - Time before the first occurrence
- `endOffset` (Duration) - Time after the last occurrence
- `frequency` (positiveInt) - Number of times to repeat in the period
- `period` (decimal) - Duration of one cycle
- `periodUnit` (code) - Unit of time for period

Current constraints only verify:
- tim-11: `startOffset` requires `frequency > 1`
- tim-12: `endOffset` requires `frequency > 1`

There is no constraint ensuring the mathematical relationship between offset, period, and frequency makes clinical sense.

## Stakeholder Perspectives

**Reporter (Hayden Bader/Epic):** Recognizes the complexity of defining a clean constraint and proposes a formula-based approach, but acknowledges it's "super clunky":
- `frequency / x = n` OR `x / frequency = n`
- Where `n` is a whole number and `x = period - startOffset - endOffset`

This would ensure the active period divides evenly into the frequency, avoiding fractional or non-sensical dosing schedules.

No other comments on this issue yet.

## Related Issues & Discussions

- No directly related Jira issues found
- No Zulip discussions found on this specific topic
- This is part of the datatypes section (2.1.30.17 Timing)

## Technical Considerations

1. **Clinical Safety**: Ambiguous dosing instructions could lead to medication errors. Constraints should prevent clinically nonsensical combinations.

2. **Constraint Expressibility**: FHIRPath constraints can express mathematical relationships, but complex formulas may be difficult for implementers to understand and for validators to report meaningful errors.

3. **Backward Compatibility**: Adding stricter constraints could invalidate existing data that was previously considered valid.

4. **Use Case Breadth**: The offset fields may have use cases beyond cyclic dosing that the workgroup should consider before adding restrictive constraints.

5. **Implementation Burden**: Complex mathematical constraints increase validation complexity and processing time.

6. **Alternative Approaches**: Rather than constraints, this might be better addressed through:
   - Enhanced documentation and examples
   - Guidance documents
   - Profile-level constraints for specific use cases (like oncology regimens)

## Potential Courses of Action

### Option A: Add Mathematical Relationship Constraint
- **Description**: Add a constraint requiring that `(period - startOffset - endOffset) / frequency` or `frequency / (period - startOffset - endOffset)` yields a whole number.
- **Pros**:
  - Prevents mathematically nonsensical combinations
  - Enforces unambiguous dosing instructions
- **Cons**:
  - Complex constraint to express and validate
  - May be overly restrictive for edge cases
  - Error messages may be confusing to end users
  - May not cover all valid use cases
- **Impact**: Compatible, substantive change (tighter constraint)

### Option B: Require Period When Using Offsets
- **Description**: Strengthen the existing constraints to require `period` (not just `frequency`) when `startOffset` or `endOffset` is used.
- **Pros**:
  - Simpler than full mathematical relationship
  - Ensures basic components are present
  - Easier to validate and report errors
- **Cons**:
  - Doesn't fully prevent ambiguous combinations
  - Still allows confusing frequency values
- **Impact**: Compatible, substantive change

### Option C: Add Documentation and Examples Only
- **Description**: Add detailed documentation explaining proper use of offsets, with clear examples of correct and incorrect usage, without adding constraints.
- **Pros**:
  - No breaking changes
  - Provides guidance without restricting valid edge cases
  - Allows clinical judgment
- **Cons**:
  - Doesn't prevent invalid data at validation time
  - Relies on implementer understanding
- **Impact**: Non-substantive (documentation)

### Option D: Create Best Practice Invariant
- **Description**: Add a best-practice (warning-level) invariant that flags potentially confusing combinations without making them invalid.
- **Pros**:
  - Provides feedback without blocking data
  - Allows valid edge cases to proceed
  - Encourages better data without breaking existing systems
- **Cons**:
  - Warnings often ignored
  - Doesn't solve the ambiguity problem
- **Impact**: Compatible, substantive change

### Option E: Defer to Dosage/Medication Profiles
- **Description**: Keep the base Timing datatype flexible and address these constraints in specific Dosage-related profiles or Implementation Guides (e.g., oncology medication IGs).
- **Pros**:
  - Keeps base datatype general-purpose
  - Allows domain-specific constraints
  - Doesn't over-constrain non-medication uses of Timing
- **Cons**:
  - Inconsistent validation across implementations
  - May not be applied where needed
- **Impact**: No change to core spec

## Questions for the Workgroup

1. What are the actual use cases for `startOffset` and `endOffset`? Are there non-cyclic-dosing scenarios?

2. Is there clinical consensus on what mathematical relationships between these values are "valid"?

3. Would a simpler constraint (e.g., require period when offset exists) be sufficient, or is the full mathematical relationship needed?

4. Should this be a hard constraint (error) or a warning-level best practice?

5. Are there existing implementations using offsets that might be broken by tighter constraints?

6. Would this be better addressed at the Dosage level rather than the general Timing datatype?

## References

- [Timing Datatype](https://build.fhir.org/datatypes.html#Timing)
- [Jira Issue FHIR-54062](https://jira.hl7.org/browse/FHIR-54062)
- Section 2.1.30.17 of FHIR Core Specification
