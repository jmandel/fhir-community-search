# FHIR-54476: StructureMap doesn't happily represent the chaining of properties in source or target

## Issue Overview

This ballot comment from Brian Postlethwaite identifies a representation gap in how the StructureMap resource handles property chaining that is valid in the FHIR Mapping Language text syntax.

The FML syntax supports chaining properties:
```
context.element(.subElement)  // Can recursively go to any depth
```

However, it's unclear how this translates to the StructureMap resource structure, which has single `element` properties in both `source` and `target` definitions.

## Current State

The FHIR Mapping Language documentation states that property chaining is supported:
> `context.element(.subElement):` where the subElement can recursively to any further depth

The StructureMap resource has:
- `StructureMap.group.rule.source.element` (0..1 string)
- `StructureMap.group.rule.target.element` (0..1 string)

Both are single string fields, not repeating.

**Questions raised:**
1. Should implementations expand `a.b.c` into nested `then` clauses when converting FML to StructureMap?
2. What variable naming convention should be used for intermediate elements?
3. Can a round-tripper (StructureMap → FML → StructureMap) preserve the original structure?

The commenter notes that while target supports chaining in FML, the source side doesn't have this capability documented, making some maps larger than necessary.

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite):** 
- Notes the mismatch between FML syntax capabilities and StructureMap representation
- Suggests making the `element` property repeating in both source and target
- Wants clarification on how source `context.element` can repeat into child elements

## Related Issues & Discussions

- **FHIR-54473** (Triaged): "FHIR Mapping Language not ready for normative" - Parent concern
- **FHIR-54474** (Triaged): "Source should be able to be a fhirpath expression" - Related source flexibility concern
- **FHIR-20842** (Published): "Dependent variables should be of type 'id'" - Historical StructureMap issue

No specific Zulip discussions found on this exact topic.

## Technical Considerations

1. **Representation Mismatch**: FML text allows `src.a.b.c`, but StructureMap only has a single `element` field. Current options:
   - Put the entire path in one string: `element: "a.b.c"`
   - Expand to nested rules with intermediate variables
   - Some other encoding

2. **Round-Tripping**: If FML compiles to expanded nested rules, converting back loses the concise notation. This affects:
   - StructureMap editing tools
   - Debugging/reviewing maps
   - Map comparison

3. **Source vs Target Asymmetry**: The spec mentions chaining for targets but not explicitly for sources. Should both be symmetric?

4. **StructureMap Change Impact**: Making `element` repeating would be a breaking change to the resource structure.

5. **Implementation Burden**: If chained paths are stored as dot-separated strings, parsers must handle this. If expanded to nested rules, compilers must handle this.

6. **Grammar Clarity**: The FML grammar should be explicit about what property chaining means in source vs target contexts.

## Potential Courses of Action

### Option A: Make element Repeating
- **Description**: Change `StructureMap.group.rule.source.element` and `.target.element` from 0..1 to 0..* to directly represent property chains.
- **Pros**:
  - Direct representation of chains
  - Enables round-tripping
  - Clear structure
- **Cons**:
  - Breaking change to StructureMap
  - Migration needed for existing maps
  - Processing logic changes
- **Impact**: Non-compatible (resource structure change)

### Option B: Document Dot-Notation in Single String
- **Description**: Clarify that `element` can contain dot-separated paths (e.g., `a.b.c`) and document parsing rules.
- **Pros**:
  - No resource change
  - Backward compatible
  - Simple representation
- **Cons**:
  - String parsing required
  - Dots in element names could be ambiguous
  - Less structured
- **Impact**: Non-substantive (clarification)

### Option C: Document Expansion to Nested Rules
- **Description**: Specify that FML compilers should expand property chains into nested `then` clauses with generated variable names.
- **Pros**:
  - No resource change
  - Works with current structure
  - Explicit processing model
- **Cons**:
  - Loses concise representation
  - Round-tripping produces different FML
  - Generated variable naming convention needed
- **Impact**: Non-substantive (clarification)

### Option D: Add Extension for Original Path
- **Description**: Keep current structure but add an extension to preserve the original chained path for round-tripping.
- **Pros**:
  - Backward compatible
  - Enables round-tripping
  - Existing structure unchanged
- **Cons**:
  - Extension overhead
  - Two representations to maintain
  - Complexity
- **Impact**: Compatible, substantive

### Option E: Symmetric Source and Target Chaining
- **Description**: Ensure both source and target support the same chaining capabilities, and document this clearly.
- **Pros**:
  - Consistent behavior
  - Addresses reporter's concern about source limitation
- **Cons**:
  - May require structural changes
  - Still need to decide on representation
- **Impact**: Depends on representation choice

## Questions for the Workgroup

1. **Current Behavior**: How do existing implementations (HAPI, Matchbox) handle property chaining in FML? What goes in the StructureMap?

2. **Dot Notation**: Is `a.b.c` currently stored as a single string in `element`? Is this documented/intended?

3. **Round-Trip Requirement**: Is round-trip fidelity (FML → StructureMap → identical FML) a requirement?

4. **Source Chaining**: Should source support the same chaining syntax as target? If so, how?

5. **Breaking Change Appetite**: Is a non-compatible change to StructureMap acceptable for cleaner representation?

6. **Variable Naming**: If expansion to nested rules is the approach, what naming convention for intermediate variables?

## References

- [FHIR Mapping Language - Rules](https://build.fhir.org/mapping-language.html)
- [StructureMap Resource](https://build.fhir.org/structuremap.html)
- [Jira Issue FHIR-54476](https://jira.hl7.org/browse/FHIR-54476)
- Section 7.8 of FHIR Core Specification
