# FHIR-53907: SearchParameter.expression should define a FHIRPath subset you SHOULD use

## Issue Overview

This ballot comment responds to the explicit request in the spec: "We are seeking input on approaches to managing the balance between expressiveness and performance impact on servers from the use of various FHIRPath features in search parameter expressions."

The commenter (James Jahns) argues that FHIR should define a limited subset of FHIRPath that implementers SHOULD use for SearchParameter.expression. This would benefit server implementers who don't implement full FHIRPath engines and would encourage IGs to create reasonably computable custom search parameters.

The commenter provides detailed analysis showing that while the spec uses various FHIRPath features (where, ofType, extension, repeat, combine, comparators, etc.), there's no guidance on which subset is recommended, and the spec itself is inconsistent in expressing equivalent functionality.

## Current State

The current spec says: "While SearchParameter.expression allows for the full use of FHIRPath, this specification restricts expressions to the 'simple' subset" - but this statement has been identified as problematic in recent FHIR-I discussions.

The specification currently:
- Uses various FHIRPath functions without documenting a recommended subset
- Has inconsistencies in how equivalent operations are expressed (e.g., `as` vs `ofType()`)
- Has different syntax for the same logical operation across versions (value-date in STU3 vs R4 vs R6)
- Recently added `.repeat()` for nested element searches (FHIR-49784), which is NOT in the "simple" subset

Zulip discussions reveal significant confusion:
- Brian Postlethwaite noted: "simple subset doesn't contain where, this isn't the purpose of the simple subset - its purpose is for direct property referencing, not searching/finding elements based on criteria"
- Grahame Grieve noted conflicting dispositions between FHIR-51587 and FHIR-49784

## Stakeholder Perspectives

**James Jahns (Reporter/Server Implementer)**: Built a FHIR server with limited FHIRPath filtering for performance reasons. Had to manually parse/evaluate SearchParameter definitions to derive the actual subset needed. Wants guidance for both core spec consistency and IG authors.

**Brian Postlethwaite (FHIR-I)**: The "simple subset" statement is "wildly wrong" - where() is not in simple subset but is essential for search parameters. The only real restriction should be around resolve() usage.

**Grahame Grieve (FHIR-I)**: Acknowledged conflicting guidance between approved tickets and unclear spec text.

## Related Issues & Discussions

### Related Jira Issues
- **FHIR-51587** (Applied): "Core spec FHIRpath should be validated" - Added note about FHIRPath usage but created confusion about "simple subset"
- **FHIR-49784** (Applied): "Definition of SearchParams on nested elements" - Added .repeat() function which contradicts simple subset restriction

### Zulip Discussions
- **#fhir/infrastructure-wg > SearchParameter.expression**: Grahame and Brian discuss contradictory guidance (Nov 2025)
- **#fhir/infrastructure-wg > Search parameter fhirpath**: Brian objects to simple subset characterization

## Technical Considerations

1. **Performance vs Expressiveness**: Full FHIRPath is Turing-complete with resolve() - servers can't pre-index arbitrary expressions

2. **Current Functions Used by Core Spec** (per commenter's analysis):
   - `.where(resolve() is {Resource})` - type narrowing
   - `.where({field}='{constant}')` - constant filtering
   - `.ofType({Type})` - type filtering
   - Comparators (!=) 
   - `.exists()`
   - Or logic (|)
   - `.extension('{url}')`
   - `.repeat({field})` - nested elements
   - `.combine({field})`
   - `as {Resource}`

3. **Simple Subset Definition**: The FHIRPath simple subset is for direct property paths, not filtering - it explicitly excludes functions like where()

4. **Consistency Problem**: Same operation expressed differently:
   - R6: `ActivityDefinition.subject.ofType(canonical)` vs `Task.focus.ofType(canonical)` - different element naming
   - `as` vs `ofType()` for same purpose

## Potential Courses of Action

### Option A: Define "Search Parameter FHIRPath Subset"
- **Description**: Create a new named subset specifically for search parameters, documenting allowed functions and patterns
- **Pros**: Clear guidance; consistent expectations; easier server implementation
- **Cons**: Requires careful definition work; may limit future expressiveness; maintenance burden
- **Impact**: High - new spec content, potentially affects IGs

### Option B: Document Current Usage Patterns as SHOULD
- **Description**: Document the functions currently used in core spec as recommended patterns, without creating formal subset
- **Pros**: Less formal; captures current practice; provides guidance without strict rules
- **Cons**: Less enforceable; doesn't address inconsistencies within core
- **Impact**: Medium - documentation addition

### Option C: Remove "Simple Subset" Claim, Add resolve() Guidance Only
- **Description**: Remove the incorrect statement about simple subset, keep only the resolve() restriction guidance that was added in FHIR-51587
- **Pros**: Fixes the immediate contradiction; accurate to actual practice
- **Cons**: Doesn't address the broader question about expressiveness/performance balance
- **Impact**: Low - corrective edit

### Option D: Create Tiered Conformance Levels
- **Description**: Define multiple conformance levels (e.g., Basic, Standard, Full) for search parameter FHIRPath support
- **Pros**: Allows servers to declare capability level; IGs can target specific levels
- **Cons**: Complexity; may fragment ecosystem; conformance testing burden
- **Impact**: High - significant new conformance infrastructure

## Questions for the Workgroup

1. Should FHIR define an official FHIRPath subset for search parameters, or is guidance sufficient?

2. What is the actual intended restriction? Just resolve() across resource boundaries, or more?

3. Should inconsistencies in core spec expressions (like `as` vs `ofType()`) be normalized?

4. How should IGs be guided to create "implementable" custom search parameters?

5. Should there be QA tooling to validate search parameter expressions against recommended patterns?

6. Is this blocking for R6 normative, or can it be addressed in future versions?

## References

- Jira Issue: https://jira.hl7.org/browse/FHIR-53907
- Related: https://jira.hl7.org/browse/FHIR-51587 (FHIRPath validation)
- Related: https://jira.hl7.org/browse/FHIR-49784 (repeat function)
- SearchParameter: https://build.fhir.org/searchparameter.html
- FHIRPath Simple Subset: https://build.fhir.org/fhirpath.html#simple
- Zulip: https://chat.fhir.org/#narrow/stream/fhir%2Finfrastructure-wg/topic/SearchParameter.expression
