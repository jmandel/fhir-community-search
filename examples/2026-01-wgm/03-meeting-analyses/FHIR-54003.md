# FHIR-54003: Add more elements to Bundle.request and Bundle.response

## Issue Overview

Hanhong Lu (Epic) notes that `Bundle.request` and `Bundle.response` only contain a subset of the HTTP headers documented on the HTTP page. The issue raises two specific questions:

1. Should `Bundle.request` have a generic/custom header element to capture custom headers?
2. Should `Bundle.response` have a `content-location` element for async patterns?

This is a completeness issue - the Bundle structure doesn't fully capture all HTTP interaction metadata that may be needed for round-tripping or async operations.

## Current State

**Current Bundle.request elements:**
- method (required)
- url (required)
- ifNoneMatch
- ifModifiedSince
- ifMatch
- ifNoneExist

**Current Bundle.response elements:**
- status (required)
- location
- etag
- lastModified
- outcome (OperationOutcome)

**Missing from request (per HTTP page):**
- Custom headers (X-* headers)
- Accept header variants
- Prefer header
- Authorization (though typically handled separately)

**Missing from response (per HTTP page):**
- Content-Location (important for async patterns)
- Custom response headers
- Prefer header responses

## Stakeholder Perspectives

**Reporter (Hanhong Lu, Epic)**: Identifies specific gaps affecting async patterns and custom header scenarios. Epic likely has real-world use cases driving these needs.

No other comments yet.

## Related Issues & Discussions

**Zulip** - #analytics on FHIR > "Async pattern discussion":
- Discussion about async completion patterns using 303 See Other
- Content-Location header is important for async job status polling
- Bundle.response currently can't capture async-related headers

**Zulip** - Various Bundle/HTTP discussions:
- Implementations wanting to capture full request/response metadata in Bundles
- Custom headers used for tracing, tenant identification, etc.

## Technical Considerations

1. **Async operations**: Modern FHIR servers increasingly support async patterns. Without Content-Location in Bundle.response, async status can't be captured in batch-response bundles.

2. **Custom headers**: IGs and implementations often define custom headers (e.g., X-Request-Id, X-Correlation-Id, tenant identifiers). These can't be captured in current Bundle structure.

3. **Round-trip fidelity**: For auditing, debugging, and replay scenarios, capturing full HTTP metadata is valuable.

4. **Scope creep risk**: Adding every possible HTTP header to Bundle could make it unwieldy.

5. **Generic vs specific**: A generic "headers" element is more flexible but less type-safe than specific named elements.

6. **Size impact**: Additional elements increase Bundle size, especially for large batch operations.

7. **Security**: Some headers (Authorization, cookies) should NOT be captured in Bundles for security reasons.

## Potential Courses of Action

### Option A: Add Specific Missing Elements
- **Description**: Add `contentLocation` to Bundle.response and `prefer` to Bundle.request
- **Pros**: 
  - Addresses most critical gaps
  - Type-safe, well-defined
  - Minimal change
- **Cons**: 
  - Doesn't address custom header needs
  - May need more additions later
- **Impact**: Compatible, substantive (new elements)

### Option B: Add Generic Header Element
- **Description**: Add `header` element (0..*) to both request and response with name/value pairs
- **Pros**: 
  - Flexible, future-proof
  - Addresses custom header needs
  - Single solution for multiple gaps
- **Cons**: 
  - Less type-safe
  - Could capture sensitive headers if not careful
  - More complex to process
- **Impact**: Compatible, substantive (new element)

### Option C: Combination Approach
- **Description**: Add specific `contentLocation` element + generic `customHeader` element (explicitly excluding standard FHIR headers)
- **Pros**: 
  - Type-safe for standard headers
  - Flexible for custom headers
  - Clear separation
- **Cons**: 
  - More complex structure
  - Needs clear guidance on what goes where
- **Impact**: Compatible, substantive

### Option D: Use Extensions
- **Description**: Define standard extensions for additional header capture rather than modifying Bundle
- **Pros**: 
  - Doesn't change core Bundle structure
  - Extensions can be adopted selectively
- **Cons**: 
  - Less discoverable
  - Inconsistent with existing request/response elements
  - Extensions on backbone elements can be awkward
- **Impact**: Non-substantive (extension approach)

### Option E: Defer to IG-Level Solutions
- **Description**: Document that IGs requiring additional headers should define extensions
- **Pros**: 
  - No core spec change
  - Flexibility for different needs
- **Cons**: 
  - Doesn't solve common async pattern need
  - Fragmentation across IGs
- **Impact**: Non-substantive

## Questions for the Workgroup

1. Is async pattern support (Content-Location) important enough to add to Bundle.response?

2. Should custom headers be supportable in Bundle, or is this out of scope for core?

3. If adding header support, should it be specific elements or generic name/value pairs?

4. What headers should explicitly NOT be capturable (security considerations)?

5. Should Prefer header (request) and its response be captured?

6. Does this need coordination with the Bulk Data or Async IG teams?

## References

- [FHIR-54003 Jira Issue](https://jira.hl7.org/browse/FHIR-54003)
- [Bundle resource](https://build.fhir.org/bundle.html)
- [HTTP page - headers](https://build.fhir.org/http.html#Http-Headers)
- [HTTP page - custom headers](https://build.fhir.org/http.html#custom)
- [Async pattern](https://build.fhir.org/async.html)
- [Zulip: Async pattern discussion](https://chat.fhir.org/#narrow/stream/analytics%20on%20FHIR/topic/Async%20pattern%20dicsussion)
