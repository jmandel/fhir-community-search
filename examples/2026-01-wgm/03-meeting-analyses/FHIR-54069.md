# FHIR-54069: Extensive refinements/extensions to the terminology fhirpath extensions

## Issue Overview

This ballot comment from Brian Postlethwaite raises multiple concerns about the documentation and design of the `%terminology` FHIRPath factory functions. The primary issues include:

1. **Undocumented parameter handling**: No guidance on how to URL-encode complex parameters like `Coding`, `CodeableConcept`, or `CodeSystem` when using the `params` parameter.

2. **Missing examples**: Each function should have examples showing sensible use cases.

3. **Unclear function benefits**: The `%terminology.subsumes` function's value proposition compared to the fluent `subsumes` or `subsumedBy` functions is not explained.

4. **Missing remote service guidance**: No documentation on what happens when a terminology server is unavailable (referenced as separate ticket FHIR-53953).

5. **Inconsistent design**: The `%factory` functions use `{}` to skip unused parameters, which is inconsistent with other FHIRPath patterns.

A comment from Michael Lawley (CSIRO) reinforces the concern: "There is no way to URL-encode a CodeableConcept. If these functions need to be able to accept 'complex' parameters then something like a Parameters object is required."

## Current State

The FHIRPath page includes a Terminology Service API section with `%terminology` factory functions that wrap FHIR terminology operations:

- `%terminology.expand(valueSet, params)` - Expand a value set
- `%terminology.lookup(coding, params)` - Look up a code
- `%terminology.validate(valueSet, codedValue, params)` - Validate a code
- `%terminology.translate(conceptMap, coding, params)` - Translate a code
- `%terminology.subsumes(system, codeA, codeB, params)` - Check subsumption
- `%terminology.at(url)` - Point to a specific terminology server

The `params` parameter is described as accepting "a string with URL parameters (name=value&etc.)" but complex FHIR types like Coding cannot be URL-encoded in a standard way.

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite):** Requests comprehensive documentation improvements, examples, and clarification of when to use factory functions vs. fluent functions.

**Michael Lawley (CSIRO/Ontoserver):** Points out the fundamental problem that CodeableConcept cannot be URL-encoded. Suggests Parameters object might be needed for complex inputs.

## Related Issues & Discussions

- **FHIR-53953** (Triaged): "No documentation on remote interactions - timeouts, error handling, caching, performance etc." - Broader issue about remote service behavior in FHIRPath
- **FHIR-54073** (Triaged): "Terminology functions should be fluent like most fhirpath functions" - Related design concern
- **FHIR-46082** (Applied): "FHIRPath %terminologies: which server?" - Previously resolved issue about terminology server specification

**Zulip Discussions:**
- The #fhirpath "Object creation" thread discusses the broader topic of factory functions vs. fluent patterns, with participants noting implementation considerations.

## Technical Considerations

1. **URL Encoding Limitations**: Standard URL encoding works for simple strings but not for complex FHIR types. The terminology $lookup, $validate-code, and $translate operations can accept complex parameters that cannot be represented as URL query parameters.

2. **Parameters Resource**: The FHIR operations use Parameters resources for complex inputs. FHIRPath would need a way to construct/pass Parameters objects, which ties into the broader %factory discussion.

3. **Fluent vs Factory**: Existing fluent functions like `memberOf()`, `subsumes()`, and `subsumedBy()` provide cleaner syntax for common cases. The factory functions add complexity for marginal additional capability.

4. **Implementation Status**: Limited implementation experience with these factory functions may mean the design hasn't been validated in practice.

5. **Normative Implications**: If this content goes normative, the API becomes locked. Getting the design right before normative status is critical.

## Potential Courses of Action

### Option A: Comprehensive Documentation Enhancement
- **Description**: Add detailed documentation addressing all concerns:
  - Explicitly list which parameters are supported (not all operation parameters)
  - Add examples for each function
  - Document behavior when terminology server unavailable
  - Clarify relationship between factory and fluent functions
- **Pros**:
  - Addresses immediate usability concerns
  - Doesn't require API changes
- **Cons**:
  - Doesn't solve the fundamental URL-encoding problem for complex types
  - May document limitations that make functions less useful than expected
- **Impact**: Non-substantive (documentation)

### Option B: Add Parameters Object Support
- **Description**: Allow `params` to accept a Parameters resource (or a FHIRPath-constructable equivalent) rather than just a URL string.
- **Pros**:
  - Enables full operation parameter support
  - Aligns with how FHIR operations work
- **Cons**:
  - Requires way to construct Parameters in FHIRPath (ties to %factory)
  - More complex implementation
  - May be scope creep for R6
- **Impact**: Compatible, substantive change

### Option C: Restrict to Supported Parameters Only
- **Description**: Explicitly document that only simple (URL-encodable) parameters are supported. Remove or mark as unsupported any parameters requiring complex types.
- **Pros**:
  - Honest about limitations
  - Simpler implementation requirements
- **Cons**:
  - Reduces functionality compared to full operations
  - May not meet user needs
- **Impact**: Non-substantive (clarification)

### Option D: Move to Incubator
- **Description**: Move the `%terminology` factory functions to an incubator IG for further development, keeping only the proven fluent functions (`memberOf`, `subsumes`, `subsumedBy`) in the normative spec.
- **Pros**:
  - Allows more iteration on design
  - Doesn't lock in potentially flawed API
  - Fluent functions already well-understood
- **Cons**:
  - Reduces available functionality in core
  - May delay useful features
- **Impact**: Non-compatible if removing from normative track

### Option E: Redesign as Fluent Functions
- **Description**: Replace factory-style `%terminology.xxx()` with fluent functions as proposed in FHIR-54073 (e.g., `coding.translate(conceptMapUrl)`).
- **Pros**:
  - Consistent with FHIRPath design philosophy
  - Cleaner syntax
  - Natural handling of input types
- **Cons**:
  - Significant redesign
  - Would need to address same params question for additional options
- **Impact**: Non-compatible change to API

## Questions for the Workgroup

1. What complex parameters are actually needed for real-world FHIRPath terminology use cases? Can most uses be satisfied with simple parameters?

2. Is there appetite for a Parameters construction mechanism in FHIRPath, or should we restrict to what's URL-encodable?

3. Should these functions be normative in R6, or do they need more implementation experience?

4. What's the relationship between these factory functions and the existing fluent terminology functions? Can we consolidate?

5. How should errors/unavailability from terminology servers be surfaced in FHIRPath expressions?

## References

- [FHIRPath Terminology Service API](https://build.fhir.org/fhirpath.html#txapi)
- [Jira Issue FHIR-54069](https://jira.hl7.org/browse/FHIR-54069)
- [FHIR-53953: Remote interactions documentation](https://jira.hl7.org/browse/FHIR-53953)
- Section 2.1.9.4 of FHIR Core Specification
