# FHIR-54483: How should error messages be reported - FML or StructureMap location?

## Issue Overview

Brian Postlethwaite raises an important question about error reporting in FHIR Mapping Language implementations: when an engine reports parsing or evaluation errors, should the error locations reference positions in the FML text format or locations within the StructureMap resource structure?

This is a practical usability concern for developers working with mapping engines. Since both FML (human-readable text) and StructureMap (JSON/XML resource) are valid input formats, error messages need to be useful regardless of which format the user started with.

The question extends to how error information should be structured in OperationOutcome.issue.expression, which uses FHIRPath-style expressions to identify locations.

## Current State

The specification currently does not provide guidance on error reporting for mapping engines. When users encounter errors:

- **FML Input**: Users expect line/column numbers referencing their FML source
- **StructureMap Input**: Users expect FHIRPath expressions like `StructureMap.group[0].rule[2].source[0]`
- **Mixed Scenarios**: When FML is converted to StructureMap internally, what should error locations reference?

There is no standardized format for mapping engine error messages, leading to inconsistent developer experiences across different tools (HAPI, Matchbox, etc.).

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite):** As someone building FML tooling (FHIRPath-Lab), Brian needs clarity on how to report errors in a way that's useful to developers and consistent with other implementations.

No other comments have been posted yet.

## Related Issues & Discussions

- **FHIR-54481**: No official FML to StructureMap mapping (related - without formal mapping, error location translation is harder)
- **FHIR-54484**: Transform functions issues (error reporting would reference these functions)

### Zulip Discussions
- FML parsing errors discussed in #FHIR Mapping Language channel
- Users often struggle to locate errors when FML is converted to StructureMap

## Technical Considerations

1. **OperationOutcome.issue.expression**: Currently defined as FHIRPath format - how does this apply to FML line/column locations?

2. **Tooling Integration**: IDEs and editors expect line/column for text files; API responses expect structured paths

3. **Source Maps**: Similar to JavaScript source maps, FML implementations could maintain mappings between FML positions and StructureMap paths

4. **Dual Reporting**: Some contexts (like IDEs) need line/column; others (like API validation) need FHIRPath expressions

5. **User Context**: The error format should match what the user submitted (if they posted FML, errors should reference FML)

## Potential Courses of Action

### Option A: Format-Specific Error Reporting
- **Description**: Specify that engines SHOULD report errors in the same format as the input - FML line/column for FML input, FHIRPath for StructureMap input
- **Pros**: 
  - Most intuitive for users
  - Matches user's mental model
  - Easy to implement for single-format engines
- **Cons**: 
  - Engines that convert FML to StructureMap internally may lose position information
  - Different error formats complicate tooling that handles both
- **Impact**: Low specification effort, may require implementation changes

### Option B: Always Use StructureMap FHIRPath
- **Description**: Standardize on FHIRPath-style expressions referencing StructureMap elements, regardless of input format
- **Pros**: 
  - Consistent error format
  - Works well with OperationOutcome.issue.expression
  - Unambiguous resource path identification
- **Cons**: 
  - Poor developer experience for FML authors
  - Requires users to understand FML â†’ StructureMap mapping
  - Loses useful line/column information
- **Impact**: Medium specification effort, simpler implementation

### Option C: Dual Location Reporting
- **Description**: Define an extension or additional element to report both FML location (line/column) AND StructureMap path when applicable
- **Pros**: 
  - Maximum information for tooling
  - Supports all use cases
  - IDEs get line/column, APIs get FHIRPath
- **Cons**: 
  - More complex specification
  - Implementation overhead
  - May be overkill for simple use cases
- **Impact**: Higher specification effort, most complete solution

### Option D: Implementation-Defined (Status Quo)
- **Description**: Leave error reporting format as implementation-defined, only requiring that errors be reported somehow
- **Pros**: 
  - No specification work needed
  - Implementations can optimize for their use case
- **Cons**: 
  - Inconsistent developer experience
  - Harder to build portable tooling
  - May cause confusion when switching between engines
- **Impact**: No effort, maintains current problems

## Questions for the Workgroup

1. What is the primary use case for mapping engine errors - developer tooling (IDEs) or runtime validation (APIs)?

2. Should FML-specific error reporting be addressed in the core spec or in an implementation guide?

3. Do existing implementations (HAPI, Matchbox) have established patterns that should be adopted?

4. Should we define a standard extension for OperationOutcome to carry source text positions (line/column)?

5. Is this something that needs to be normative, or could it be guidance/best practice?

## References

- Jira: https://jira.hl7.org/browse/FHIR-54483
- FHIR Mapping Language: https://hl7.org/fhir/6.0.0-ballot4/mapping-language.html
- OperationOutcome: https://hl7.org/fhir/operationoutcome.html
- OperationOutcome.issue.expression: FHIRPath expression for error location
