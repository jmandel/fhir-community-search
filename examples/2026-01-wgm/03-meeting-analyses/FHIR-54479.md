# FHIR-54479: Dependent Group parameter variable restrictions

## Issue Overview

This ballot comment from Brian Postlethwaite identifies gaps in the specification for how parameters are handled when calling dependent groups in FML. The Dependent Rules section states:

> "The parameters provided must match the parameters required by the dependent group, in order. In addition, the mode of the variable must match - inputs that are targets must be target variables. Note, though, that target variables can be treated as source for a group."

The issues raised are:

1. **Literal parameters**: No documentation on how literal/constant parameters should be handled
2. **Source/target mode for literals**: Are literal values considered source or target variables, or can they be used as either?
3. **FHIRPath expression collections**: If a FHIRPath expression produces a collection, can that collection be passed to a group? The spec should clarify whether groups process collections in their rules normally.

## Current State

The FML grammar supports passing parameters to dependent groups:
```
... then groupName(var1, var2, literal, fhirpathExpr)
```

The specification addresses variable mode matching (source vs target) but doesn't cover:
- How literal values are treated (as source? target? either?)
- Whether FHIRPath expressions can produce collections passed to groups
- What happens if a passed collection has multiple items

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite):**
- Wants clarification on literal parameter handling
- Questions whether FHIRPath expression results (potentially collections) can be passed to groups
- Notes grammar supports this but semantics are unclear

No other comments on this issue yet.

## Related Issues & Discussions

- **FHIR-54473** (Triaged): "FHIR Mapping Language not ready for normative" - Parent concern
- **FHIR-54478** (Triaged): "How can groups produce collections?" - Related collection handling question
- **FHIR-54474** (Triaged): "Source should be able to be a fhirpath expression" - Related FHIRPath usage question

**Zulip:**
- "where clause" thread discusses FHIRPath context and variable availability in FML
- No specific discussion found on dependent group parameter handling

## Technical Considerations

1. **Literal Values**: When calling `groupName(src, 'literalString')`, is `'literalString'`:
   - A source parameter (read-only)?
   - A target parameter (can be modified)?
   - Treated specially?

2. **FHIRPath Results**: When calling `groupName(src, src.someExpr.results())`, if the expression returns multiple items:
   - Is the group called once with a collection?
   - Is the group called multiple times, once per item?
   - Is this an error?

3. **Mode Matching**: The spec says "inputs that are targets must be target variables." Does this mean:
   - Literals cannot be target parameters?
   - FHIRPath expression results cannot be target parameters?

4. **Grammar vs Semantics**: The grammar allows these constructs, but the semantic behavior isn't specified.

5. **Implementation Variance**: Without clear specification, implementations may handle these cases differently.

## Potential Courses of Action

### Option A: Document Literal Handling
- **Description**: Add clear documentation specifying:
  - Literals are treated as source-mode parameters
  - They cannot be modified by the called group
  - Include examples showing valid and invalid usage
- **Pros**:
  - Clarifies common case
  - Simple rule
  - Consistent with expectation that literals are immutable
- **Cons**:
  - May limit some use cases
- **Impact**: Non-substantive (clarification)

### Option B: Document FHIRPath Expression Handling
- **Description**: Specify how FHIRPath expression results are handled:
  - Expression results are source-mode
  - Collections are passed as-is (group rules iterate normally)
  - Alternative: group is invoked once per item in collection
- **Pros**:
  - Clarifies behavior
  - Enables powerful patterns
- **Cons**:
  - Needs careful design to be consistent
- **Impact**: Non-substantive (clarification)

### Option C: Add Examples for All Parameter Types
- **Description**: Add comprehensive examples in the specification showing:
  - Variable parameters (source and target)
  - Literal parameters
  - FHIRPath expression parameters
  - Collection handling in each case
- **Pros**:
  - Practical guidance
  - Shows intent clearly
- **Cons**:
  - Examples don't replace normative text
- **Impact**: Non-substantive (documentation)

### Option D: Restrict to Variables Only
- **Description**: Clarify that dependent group parameters must be variables, not literals or FHIRPath expressions. Force users to assign to variables first.
- **Pros**:
  - Simpler semantics
  - Clear mode determination
  - Consistent with current spec language about "variables"
- **Cons**:
  - Less flexible
  - More verbose for simple cases
- **Impact**: Could be breaking if grammar allows broader usage

### Option E: Comprehensive Parameter Specification
- **Description**: Fully specify parameter handling:
  - Variables: mode as declared
  - Literals: source mode only
  - FHIRPath expressions: source mode, collection passed as-is
  - Error cases documented
- **Pros**:
  - Complete specification
  - All cases covered
- **Cons**:
  - Larger spec change
  - Needs implementation validation
- **Impact**: Clarification, potentially normative constraints

## Questions for the Workgroup

1. **Literal Mode**: Should literals be allowed as source parameters, target parameters, or both?

2. **Expression Mode**: Should FHIRPath expression results be allowed as source parameters, target parameters, or both?

3. **Collection Handling**: When a parameter is a collection:
   - Is the group invoked once with the collection?
   - Is the group invoked N times (once per item)?
   - Does it depend on the group's parameter definition?

4. **Current Implementations**: How do existing implementations handle these cases?

5. **Grammar Alignment**: Does the grammar need adjustment to match the semantic restrictions?

6. **Target Modification**: What happens if a group tries to modify a literal or expression-result parameter?

## References

- [FHIR Mapping Language - Dependent Rules](https://build.fhir.org/mapping-language.html#7.8.0.8.4)
- [Jira Issue FHIR-54479](https://jira.hl7.org/browse/FHIR-54479)
- [FHIR-54478: Groups producing collections](https://jira.hl7.org/browse/FHIR-54478)
- Section 7.8.0.8.4 of FHIR Core Specification
