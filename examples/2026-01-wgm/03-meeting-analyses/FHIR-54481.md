# FHIR-54481: There is no official mapping from the FML text format to the StructureMap resource

## Issue Overview

Brian Postlethwaite has raised a fundamental documentation gap regarding the FHIR Mapping Language (FML). While FML is widely used as a human-readable text format for defining mappings, there is no official specification documenting how this text format corresponds to the underlying StructureMap resource structure.

Currently, the only reference implementation for parsing FML and converting it to/from StructureMap resources exists in the HAPI FHIR Java library. This creates a problematic dependency where the de facto specification for FML parsing is defined by implementation code rather than normative documentation.

This is particularly concerning as R6 moves toward normativity - having an undocumented format that is central to the mapping language creates interoperability risks when different implementations might interpret FML syntax differently.

## Current State

The FHIR specification at https://hl7.org/fhir/mapping-language.html describes the FML syntax and provides examples, but:
- There is no formal grammar specification (e.g., ANTLR, BNF)
- There is no documented algorithm for converting FML text to StructureMap JSON/XML
- The mapping between FML constructs and StructureMap.group, StructureMap.group.rule, etc. is implicit
- The HAPI reference implementation is the only authoritative source for FML parsing behavior

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite):** As a maintainer of the .NET FHIR library and FHIRPath-Lab tooling, Brian has first-hand experience with the challenges of implementing FML parsing without formal specification. His concern is about ensuring interoperability across implementations.

No other comments have been posted yet.

## Related Issues & Discussions

- **FHIR-54483**: Related issue about error reporting for FML (FML vs StructureMap locations)
- **FHIR-54484**: Collection of issues about transform functions documentation  
- **FHIR-54485**: toDate/toDateTime format codes in FML
- **FHIR-54486**: Proposal to remove FML tutorial from core spec

### Zulip Discussions
- Active discussion in #FHIR Mapping Language channel about FML parsing challenges
- Users frequently ask about FML syntax interpretation, highlighting the documentation gap
- Discussion about FML to StructureMap conversion indicates implementers rely on HAPI behavior

## Technical Considerations

1. **Interoperability Risk**: Without formal specification, different FML parsers might produce different StructureMap resources from the same FML input

2. **Vendor Lock-in**: Current situation creates implicit dependency on HAPI's interpretation of FML

3. **Tooling Diversity**: Multiple tools now support FML (HAPI, .NET library, Matchbox, FHIRPath-Lab) - all need consistent parsing

4. **Normative Implications**: If FML becomes part of normative R6, the mapping must be precisely defined

5. **Round-trip Fidelity**: Need to ensure FML → StructureMap → FML produces equivalent results

## Potential Courses of Action

### Option A: Create Formal FML Grammar Specification
- **Description**: Develop and publish a formal grammar (ANTLR or similar) for FML, along with detailed mapping rules to StructureMap elements
- **Pros**: 
  - Complete, unambiguous specification
  - Enables conformance testing
  - Supports tooling generation
- **Cons**: 
  - Significant specification effort required
  - May reveal inconsistencies in current implementations
  - Needs ongoing maintenance as StructureMap evolves
- **Impact**: High effort, high value for long-term interoperability

### Option B: Document HAPI's Implementation as Reference
- **Description**: Extract and document the parsing rules from HAPI's implementation as the normative specification
- **Pros**: 
  - Leverages existing working implementation
  - Lower effort than creating from scratch
  - Maintains backward compatibility with existing FML content
- **Cons**: 
  - May codify HAPI-specific behaviors that aren't ideal
  - Places burden on non-Java implementations to match Java behavior
  - Any HAPI bugs become normative
- **Impact**: Medium effort, pragmatic approach

### Option C: Move FML to Separate IG/Specification
- **Description**: Extract the entire FML specification (including parsing rules) into a separate Implementation Guide with its own lifecycle
- **Pros**: 
  - Allows FML to evolve independently
  - Keeps core spec simpler
  - FML can have its own maturity track
- **Cons**: 
  - Creates fragmentation
  - StructureMap in core would need to reference external FML spec
  - May reduce perceived importance of FML
- **Impact**: Significant structural change, addresses FHIR-54486 as well

### Option D: Defer to R7
- **Description**: Mark FML-specific content as draft/STU and defer formal specification to R7
- **Pros**: 
  - Maintains current trajectory
  - Allows more implementation experience before normative commitment
- **Cons**: 
  - Continues current interoperability risks
  - Delays resolution of known problem
- **Impact**: Low effort, defers rather than resolves

## Questions for the Workgroup

1. What level of formal specification is needed for FML parsing to be considered "normatively specified"?

2. Should the FML format be normative in R6, or should only the StructureMap resource be normative?

3. Are there known parsing differences between HAPI and other implementations that need to be reconciled?

4. Would a formal test suite for FML parsing (input FML → expected StructureMap) be sufficient without a formal grammar?

5. Should this work be done by FHIR-I or delegated to a focused sub-team?

## References

- Jira: https://jira.hl7.org/browse/FHIR-54481
- FHIR Mapping Language spec: https://hl7.org/fhir/6.0.0-ballot4/mapping-language.html
- StructureMap resource: https://hl7.org/fhir/structuremap.html
- HAPI FML parser source: https://github.com/hapifhir/org.hl7.fhir.core
- Zulip #FHIR Mapping Language: https://chat.fhir.org/#narrow/stream/FHIR-Mapping-Language
