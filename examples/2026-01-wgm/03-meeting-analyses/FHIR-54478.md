# FHIR-54478: How can groups produce collections?

## Issue Overview

This ballot comment from Brian Postlethwaite raises a specification clarity question about how FML groups handle output collections. Specifically:

1. Can a group produce more than one resource instance of a given type?
2. Can a group produce instances of multiple different types?
3. How should this behave when there are multiple output parameters?

The commenter suggests this could work "like fhirpath where all things can be collections" and notes it would be consistent with how rules implicitly handle collections.

## Current State

In FML, a group is defined with input and output parameters:
```
group Example(source src : SourceType, target tgt : TargetType)
```

The specification doesn't clearly address:
- Whether `tgt` can represent multiple instances
- How multiple output parameters interact
- When/how new output instances are created

Rules within groups implicitly iterate over collections in source properties. The question is whether this collection handling extends to group outputs.

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite):**
- Wants clarity on whether groups can produce collections
- Suggests consistency with FHIRPath collection model
- Asks specifically about scenarios with multiple output parameter types

No other comments on this issue yet.

## Related Issues & Discussions

- **FHIR-54473** (Triaged): "FHIR Mapping Language not ready for normative" - Parent concern
- **FHIR-54479** (Triaged): "Dependent Group parameter variable restrictions" - Related parameter handling question
- **FHIR-54474** (Triaged): "Source should be able to be a fhirpath expression" - Related collection handling

**Zulip:**
- "Conditional group execution" discussion touches on when groups execute but not output collections

## Technical Considerations

1. **Use Case**: Mapping a single source resource to multiple target resources is common:
   - One source Patient → multiple target Observations
   - One source Bundle → multiple extracted resources
   - Cross-version expansion (one R4 resource → multiple R6 resources)

2. **Current Behavior**: Rules iterate over source collections automatically:
   ```
   src.item as i -> tgt.item = i  // Creates one target item per source item
   ```
   The question is whether the same happens at the group level.

3. **Output Instance Creation**: When is a new output instance created?
   - At group entry?
   - Explicitly via `create()` transform?
   - Implicitly when properties are assigned?

4. **Multiple Output Types**: If a group has `target tgt1 : TypeA, target tgt2 : TypeB`:
   - Are instances created for both at group entry?
   - Can rules within the group create additional instances of either?
   - How is the output collection structured?

5. **FHIRPath Consistency**: FHIRPath treats everything as collections. Aligning FML with this model would mean:
   - All parameters are inherently collections
   - Rules produce collections
   - Groups produce collections

6. **Bundle Construction**: Many mappings produce Bundles. Clear collection handling is essential for bundle entry population.

## Potential Courses of Action

### Option A: Document Collection Semantics
- **Description**: Add clear documentation specifying:
  - Group output parameters are collections
  - Initial instance creation behavior
  - How multiple instances are accumulated
  - Relationship to Bundle construction
- **Pros**:
  - Clarifies intent
  - Guides implementations
  - No structural changes
- **Cons**:
  - May conflict with existing implementations
  - Needs careful design
- **Impact**: Non-substantive (clarification)

### Option B: Explicit Collection Modifier
- **Description**: Add syntax to explicitly mark output parameters as collections:
  ```
  group Example(source src : Patient, target tgt : Observation[])
  ```
- **Pros**:
  - Explicit about intent
  - Distinguishes single vs multiple output cases
  - Clear to readers
- **Cons**:
  - Grammar change
  - May be unnecessary if everything is a collection
- **Impact**: Compatible, substantive (grammar addition)

### Option C: Everything is a Collection (FHIRPath Model)
- **Description**: Specify that all FML parameters and outputs are collections (may have 0, 1, or more items), consistent with FHIRPath.
- **Pros**:
  - Consistent with FHIRPath
  - Simple mental model
  - Flexible
- **Cons**:
  - May complicate simple single-resource mappings
  - Implementation implications
- **Impact**: Clarification/design decision

### Option D: Define Accumulation Behavior
- **Description**: Specify how output accumulation works:
  - Each target assignment adds to the collection
  - `create()` transform starts a new instance in the collection
  - Final output is the accumulated collection
- **Pros**:
  - Clear operational model
  - Matches common expectations
- **Cons**:
  - May not match all implementation approaches
  - Needs careful specification
- **Impact**: Clarification

### Option E: Defer to Implementation Experience
- **Description**: Document current implementation behaviors and defer standardization until more experience is gathered.
- **Pros**:
  - Based on real usage
  - Lower risk of wrong standardization
- **Cons**:
  - Inconsistent implementations
  - Delays clarity
- **Impact**: Minimal

## Questions for the Workgroup

1. **Current Implementations**: How do HAPI and other implementations handle multiple output instances? Is there consistency?

2. **Use Case Priority**: How important is the multiple-output-resources use case? Are there workarounds?

3. **FHIRPath Alignment**: Should FML explicitly adopt FHIRPath's "everything is a collection" model?

4. **Instance Creation**: When should a new output instance be created?
   - Implicitly at group start?
   - Explicitly via `create()` only?
   - Both?

5. **Multiple Parameters**: If a group has multiple output parameters of different types, are they independent collections?

6. **Return Semantics**: Does a group "return" its output collections, or are they modified in place?

7. **Bundle Construction**: Is there a standard pattern for constructing Bundle entries from group outputs?

## References

- [FHIR Mapping Language - Groups](https://build.fhir.org/mapping-language.html)
- [Jira Issue FHIR-54478](https://jira.hl7.org/browse/FHIR-54478)
- [FHIR-54479: Dependent Group parameters](https://jira.hl7.org/browse/FHIR-54479)
- Section 7.8 of FHIR Core Specification
