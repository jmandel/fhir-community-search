# FHIR-44665: Equivalent of CodeableReference for Canonical Resources?

## Issue Overview

This issue raises a question about how to handle elements that need to support both coded concepts and canonical references to definitional resources. The specific case is Device.definition, which is currently typed as `CodeableReference(DeviceDefinition)`, allowing identification of a device's type either by code or by reference to a DeviceDefinition resource.

With R6, DeviceDefinition is adopting the canonical resource pattern, meaning references to it should typically be `canonical(DeviceDefinition)` rather than `Reference(DeviceDefinition)`. However, there's no `CodeableCanonical` data type, leaving a gap in how to express "either a code OR a canonical reference."

The submitter asks for best practice guidance, as this pattern is likely to arise in other places beyond Device.definition.

## Current State

**CodeableReference Structure:**
```
CodeableReference:
  - concept: CodeableConcept
  - reference: Reference(ResourceType)
```

This allows expressing "either a code or a reference to a resource instance."

**The Gap:**
When the target resource is a canonical/definitional resource, the semantically correct reference type is `canonical`, not `Reference`. But there's no `CodeableCanonical` that would allow "either a code or a canonical."

**DeviceDefinition Change:**
FHIR-39389 (and FHIR-42900) established that DeviceDefinition should follow the canonical resource pattern. This triggers the need to update all references to DeviceDefinition.

## Stakeholder Perspectives

**Elliot Silver** (Reporter):
- Raised this as a general pattern question, not just a DeviceDefinition issue
- Identified three potential options in the original issue
- Asking for best practice guidance

**From FHIR-39389 Comments (DeviceDefinition canonical change):**

**Marti Velezis**: Detailed analysis of all resources referencing DeviceDefinition and how each should be updated. Notes that some elements with CodeableReference need to become choice types:
- `product[x]` with choices: CodeableConcept, Reference(Device), canonical(DeviceDefinition)
- `device[x]` with choices: CodeableConcept, canonical(DeviceDefinition)

**Jose Costa-Teixeira**: Listed 25+ resources impacted by the DeviceDefinition canonical change.

No additional comments directly on FHIR-44665.

## Related Issues & Discussions

- **FHIR-39389**: "DeviceDefinition should follow definitional resource modelling" - The trigger for this issue
- **FHIR-42900**: Related canonical resource changes
- [Canonical Resource Pattern](https://build.fhir.org/canonicalresource.html)
- [CodeableReference Data Type](https://build.fhir.org/references.html#CodeableReference)

## Technical Considerations

1. **No CodeableCanonical Type**: FHIR doesn't have a `CodeableCanonical` data type. Creating one would require a new data type definition.

2. **Choice Types Alternative**: Using `element[x]` with choices of CodeableConcept and canonical achieves similar functionality but loses the structural elegance of CodeableReference.

3. **Reference.identifier Workaround**: Placing a canonical in `CodeableReference.reference.identifier` is possible but semantically awkward - identifiers aren't meant for canonical URLs.

4. **Backward Compatibility**: Changing existing CodeableReference elements to choice types is a breaking change for implementers.

5. **Pattern Consistency**: Different resources handling this differently would create inconsistency.

6. **Canonical Resolution**: Canonicals can include version (`url|version`); how would this work in a CodeableCanonical?

## Potential Courses of Action

### Option A: Use Choice Type (element[x])
- **Description**: Replace CodeableReference with a choice: `definition[x]` with choices CodeableConcept and canonical(DeviceDefinition)
- **Pros**: Clear semantics; uses existing FHIR patterns; no new data type needed
- **Cons**: Breaking change; loses the structural elegance of CodeableReference; inconsistent with non-canonical references
- **Impact**: Non-compatible change to element structure

### Option B: Create CodeableCanonical Data Type
- **Description**: Define a new `CodeableCanonical` data type parallel to CodeableReference
- **Pros**: Clean parallel to CodeableReference; consistent pattern; type-safe
- **Cons**: New data type is significant change; tooling updates needed; increases complexity
- **Impact**: Compatible, substantive new data type

### Option C: Keep CodeableReference, Use Reference
- **Description**: Keep DeviceDefinition references as Reference within CodeableReference, ignoring that DeviceDefinition is canonical
- **Pros**: No change needed; simple
- **Cons**: Semantically incorrect; misses the point of canonical pattern; inconsistent
- **Impact**: Non-substantive (no change)

### Option D: Extend CodeableReference
- **Description**: Add an optional `canonical` element to CodeableReference alongside `concept` and `reference`
- **Pros**: Backward compatible for existing uses; single type handles all cases
- **Cons**: Makes CodeableReference more complex; potentially confusing which to use
- **Impact**: Compatible, substantive change to data type

### Option E: Use Extension on CodeableReference
- **Description**: Define an extension on CodeableReference to carry a canonical URL
- **Pros**: No core changes; can be adopted incrementally
- **Cons**: Extensions are second-class citizens; awkward pattern
- **Impact**: Non-substantive to core; creates extension

## Questions for the Workgroup

1. Is this common enough to warrant a new data type (CodeableCanonical), or should we use choice types case-by-case?

2. Should CodeableReference be enhanced to include canonical support?

3. What is the preferred migration path for existing CodeableReference elements when the target becomes canonical?

4. Are there other definitional resources (beyond DeviceDefinition) that will face this same issue?

5. What guidance should be provided to IG authors facing this pattern?

## References

- [FHIR-44665 Jira Issue](https://jira.hl7.org/browse/FHIR-44665)
- [FHIR-39389 - DeviceDefinition canonical change](https://jira.hl7.org/browse/FHIR-39389)
- [CodeableReference Data Type](https://build.fhir.org/references.html#CodeableReference)
- [Canonical Data Type](https://build.fhir.org/datatypes.html#canonical)
- [Canonical Resource Pattern](https://build.fhir.org/canonicalresource.html)
- [Device.definition](https://build.fhir.org/device-definitions.html#Device.definition)
