# FHIR-54074: %server is a long way from normative ready - move to incubator

## Issue Overview

This ballot comment from Brian Postlethwaite raises serious concerns about the `%server` General Service API in FHIRPath being proposed for normative status. The commenter argues that this functionality:

1. **Lacks implementation experience**: Was draft/maturity-0 in R5, with no evidence of implementations
2. **Has security implications**: Functions that modify data (`create`, `update`, `delete`, `patch`) could be exploited as attack vectors if evaluated in untrusted contexts (search parameters, invariants, questionnaires)
3. **Is under-specified**: Missing error handling, authorization coverage, and context documentation
4. **Has design issues**: Inconsistent parameter ordering, missing references to operations, unclear behavior

The comment strongly recommends moving this content to an incubator IG rather than making it normative.

## Current State

The `%server` General Service API provides FHIRPath functions for interacting with FHIR servers:

**Read operations:**
- `%server.read(type, id)` - Get a resource
- `%server.search(doPost, parameters)` - Search resources
- `%server.capabilities(mode)` - Get server capabilities
- `%server.everything(type, id, parameters)` - Patient/Encounter $everything

**Write operations:**
- `%server.create(resource)` - Create a resource
- `%server.update(resource)` - Update a resource  
- `%server.delete(resource)` - Delete a resource
- `%server.patch(parameters)` - Patch a resource

**Operation invocations:**
- `%server.validate(resource, mode, parameters)` - $validate
- `%server.transform(source, content)` - $transform
- `%server.apply(resource, subject, parameters)` - $apply

The specification states these return empty collections on failure rather than throwing errors.

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite):** Provides detailed technical critique:

- **Security**: "Someone just injected a trace with some side-effect resource creation in a search parameter, or an invariant, or a questionnaire, leaking sensitive data - quite the attack vector"
- **Maturity**: "Was draft - maturity=0 in R5... inappropriate to go direct to normative"
- **Missing specs**: No error reporting, authorization handling, context specification
- **Design issues**:
  - `search` has `doPost` as first parameter (should be optional, second)
  - `patch` parameters different from other functions
  - `delete` takes full resource when REST API uses id
  - `capabilities` should explicitly return CapabilityStatement
  - `everything` doesn't "get a resource" - it gets a Bundle
  - `transform` could be simpler as `transformStructure(canonicalUrl)`
  - `validate` duplicates `conformsTo()` functionality
  - `apply` description says "get a resource" but it creates resources

No other comments yet.

## Related Issues & Discussions

- **FHIR-53953** (Triaged): "No documentation on remote interactions" - Related concern about timeouts, caching, error handling
- **FHIR-46082** (Applied): "FHIRPath %terminologies: which server?" - Established the `at(url)` pattern

## Technical Considerations

1. **Security Model**: FHIRPath expressions can appear in many contexts:
   - SearchParameters (potentially user-influenced)
   - Invariants (in profiles/IGs)
   - Questionnaires (can be from external sources)
   - CDS Hooks (external services)
   
   Write operations in these contexts could be exploited.

2. **Context Specification**: The spec doesn't define which contexts should support `%server`. Not all environments should allow data modification.

3. **Error Handling**: Returning empty on failure loses error information. How do expressions know why something failed?

4. **Authorization**: No discussion of how OAuth/SMART scopes interact with these operations.

5. **Idempotency**: FHIRPath expressions may be evaluated multiple times. Write operations are not generally idempotent.

6. **Implementation Status**: No known implementations means no validation that the API works in practice.

7. **x-fhir-query Relationship**: There's existing functionality for queries in Questionnaires. How does `%server` relate?

## Potential Courses of Action

### Option A: Move Entire %server to Incubator
- **Description**: Remove all `%server` functions from normative FHIRPath spec. Create incubator IG for further development.
- **Pros**:
  - Allows proper maturation
  - No security risk from premature normative status
  - Time to address all design issues
  - Implementation experience before locking down
- **Cons**:
  - Removes functionality some may want
  - Delays server interaction capabilities
- **Impact**: Non-compatible (removal)

### Option B: Keep Read-Only, Move Write to Incubator
- **Description**: Keep `read`, `search`, `capabilities`, `everything` as normative. Move `create`, `update`, `delete`, `patch` to incubator.
- **Pros**:
  - Read operations lower security risk
  - Some functionality remains available
  - Write operations get more development time
- **Cons**:
  - Split specification
  - Still have error handling/auth questions for reads
- **Impact**: Partially non-compatible

### Option C: Add Comprehensive Safeguards and Documentation
- **Description**: Keep in normative but add:
  - Explicit context restrictions for write operations
  - Security considerations section
  - Error handling specification
  - Authorization requirements
  - Clear guidance on implementation requirements
- **Pros**:
  - Functionality available
  - Addresses immediate concerns
- **Cons**:
  - May not be sufficient for safe deployment
  - Still lacks implementation validation
  - Rushing complex security considerations
- **Impact**: Compatible, substantive

### Option D: Mark as Trial Use Within Normative
- **Description**: Include in the normative spec but mark as Trial Use (not subject to normative stability guarantees).
- **Pros**:
  - Visible for feedback
  - Can evolve based on experience
  - Clear it's not yet stable
- **Cons**:
  - Unusual pattern within normative spec
  - May confuse implementers
- **Impact**: No immediate API change

### Option E: Address Specific Issues Only
- **Description**: Fix the enumerated issues (parameter ordering, return types, documentation) without moving to incubator.
- **Pros**:
  - Addresses concrete problems
  - Maintains spec structure
- **Cons**:
  - Doesn't address fundamental maturity/security concerns
  - May be premature normative locking
- **Impact**: Mostly compatible (with some fixes)

## Questions for the Workgroup

1. **Implementation Evidence**: Are there any implementations of `%server` functions? What was their experience?

2. **Security Threat Model**: What contexts should be allowed to use write operations? How do we enforce this?

3. **Normative Criteria**: What is the bar for going from maturity-0 to normative? Does `%server` meet it?

4. **Use Cases**: What are the primary use cases for `%server` functions? Can they be met other ways?

5. **FML Relationship**: The FHIR Mapping Language has similar server interaction needs. Should these be aligned?

6. **Error Handling**: Is "return empty on failure" acceptable, or do we need a way to surface errors?

7. **Context Restrictions**: Should we define a concept of "trusted" vs "untrusted" FHIRPath evaluation contexts?

## References

- [FHIRPath General Service API](https://build.fhir.org/fhirpath.html#srvr-api)
- [Jira Issue FHIR-54074](https://jira.hl7.org/browse/FHIR-54074)
- [FHIR-53953: Remote interactions documentation](https://jira.hl7.org/browse/FHIR-53953)
- Section 2.1.9.5 of FHIR Core Specification
