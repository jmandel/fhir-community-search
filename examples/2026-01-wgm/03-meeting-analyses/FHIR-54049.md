# FHIR-54049: SubscriptionTopic cannot indicate required filters or required payload

## Issue Overview

James Jahns identifies that SubscriptionTopic currently has no mechanism for servers to indicate *required* filters or payload configurations. The current structure only describes what filters and content options are *available*, not which ones are *mandatory*.

This is important for two reasons:
1. **Implementation communication**: Servers need to convey their requirements to subscribers
2. **IG specifications**: IGs need to define realistic SubscriptionTopic expectations for implementers

Specific use cases mentioned:
- Many topics require a patient filter to limit scope/context
- Many topics require `id-only` or `empty` content for security reasons

The proposal suggests adding:
- `SubscriptionTopic.trigger.canFilterBy.required` (boolean 0..1)
- `SubscriptionTopic.supportedPayload` (code 0..*)

## Current State

**Current canFilterBy structure:**
```
trigger
  └── canFilterBy (0..*)
        ├── description
        ├── resource
        ├── filterParameter
        ├── filterDefinition
        ├── comparator (0..*)
        └── modifier (0..*)
```

**What's missing:**
- No way to mark a filter as required
- No way to restrict allowed Subscription.content values

**Current Subscription.content values:**
- `empty` - No resource content, just notification
- `id-only` - Only resource ID
- `full-resource` - Complete resource

**Subscription.filterBy:**
- Currently voluntary based on canFilterBy
- Server can reject, but topic doesn't communicate requirements upfront

## Stakeholder Perspectives

**Reporter (James Jahns)**: Has practical experience where servers need to enforce constraints (patient context, payload restrictions) that current topic structure can't communicate.

No other comments yet.

## Related Issues & Discussions

**Related issue:**
- FHIR-54046: SubscriptionTopic.trigger.event cardinality (same reporter)

**Zulip** - #subscriptions:
- Discussions about topic derivation and what can be added/restricted
- Server capability negotiation for subscriptions

**Zulip** - #argonaut > Subscriptions in HTI-2:
- Josh Mandel discussing subscription requirements for ONC regulations
- Need for clear topic specifications in IGs

## Technical Considerations

1. **Enforcement mechanism**: If a filter is marked required, what happens when a subscriber doesn't include it?
   - Server rejects subscription creation?
   - Server adds default value?
   - Subscription is created but inactive?

2. **Default values**: Should required filters have default value options?

3. **Content restrictions**: Is `supportedPayload` the right approach, or should it be `allowedContent` on the topic?

4. **Security vs capability**: Required filters may be security requirements (patient scope) or capability limitations (server can't handle unscoped queries).

5. **Derivation impact**: How do required filters interact with derivedFrom topics?

6. **CapabilityStatement relationship**: Should this also appear in CapabilityStatement.rest.resource.operation for subscription operations?

7. **Error messaging**: How should servers communicate why a subscription was rejected due to missing required filter?

## Potential Courses of Action

### Option A: Add required Flag and supportedPayload
- **Description**: Add `required` (boolean) to canFilterBy and `supportedPayload` (code 0..*) to SubscriptionTopic
- **Pros**: 
  - Direct solution to stated need
  - Minimal additions
  - Clear semantics
- **Cons**: 
  - supportedPayload location unclear (topic-level vs trigger-level?)
  - Enforcement semantics need documentation
- **Impact**: Compatible, substantive (new elements)

### Option B: Required Filters Only
- **Description**: Add `required` flag to canFilterBy; address payload constraints separately
- **Pros**: 
  - Addresses most critical need
  - Simpler change
  - Payload restrictions may need more design
- **Cons**: 
  - Partial solution
  - Payload requirement is a real use case
- **Impact**: Compatible, substantive

### Option C: Comprehensive Constraint Model
- **Description**: Add broader constraint mechanism supporting required filters, allowed payloads, and other restrictions
- **Pros**: 
  - Extensible for future needs
  - Comprehensive solution
- **Cons**: 
  - More complex
  - May be over-engineered
  - Longer to design/implement
- **Impact**: Compatible, substantive

### Option D: Use CapabilityStatement Instead
- **Description**: Document that subscription constraints should be expressed in CapabilityStatement, not SubscriptionTopic
- **Pros**: 
  - Keeps SubscriptionTopic simpler
  - CapabilityStatement is for server capabilities
- **Cons**: 
  - SubscriptionTopic is where topics are defined
  - IGs define topics, not CapabilityStatements
  - Splits related information
- **Impact**: Non-substantive (guidance)

### Option E: Extension Approach
- **Description**: Define standard extensions for required filters and payload restrictions
- **Pros**: 
  - No core structure change
  - Can be adopted incrementally
- **Cons**: 
  - Less discoverable
  - May become de facto required anyway
- **Impact**: Non-substantive

## Questions for the Workgroup

1. Is filter requirement a common enough need to add to core SubscriptionTopic?

2. Should required filters have error handling specified (reject subscription vs silent handling)?

3. Where should payload restrictions live - topic level or trigger level?

4. Should there be a default value mechanism for required filters?

5. How does this interact with topic derivation (can derived topics add/remove requirements)?

6. Are there other SubscriptionTopic constraint needs that should be addressed together?

7. Should this coordinate with the Subscriptions Backport IG team?

## References

- [FHIR-54049 Jira Issue](https://jira.hl7.org/browse/FHIR-54049)
- [SubscriptionTopic resource](https://build.fhir.org/subscriptiontopic.html)
- [SubscriptionTopic.trigger.canFilterBy](https://build.fhir.org/subscriptiontopic-definitions.html#SubscriptionTopic.trigger.canFilterBy)
- [Subscription.content](https://build.fhir.org/subscription-definitions.html#Subscription.content)
- [Subscriptions Backport IG](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/)
- Related: [FHIR-54046](https://jira.hl7.org/browse/FHIR-54046)
