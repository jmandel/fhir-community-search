# FHIR-54474: Source should be able to be a fhirpath expression

## Issue Overview

This ballot comment from Brian Postlethwaite identifies a gap in the FHIR Mapping Language: there is no way to take a single property value and split it into multiple values for mapping purposes.

The proposed solution is to allow the source in an FML rule to be a FHIRPath expression rather than just a property path. This would enable scenarios like splitting a comma-separated string into multiple output values.

**Example use case:**
```
// Desired syntax (not currently valid)
(src.codes.split(',')) as scv -> tgt.coding as c, c.code = scv
// Split an input field on comma and create a coding for each value
```

## Current State

In FML, a source definition consists of:
- `context.element` - A path from a context variable to a property
- Optional: `alias` - A name to reference the source value
- Optional: `where` - A FHIRPath filter expression
- Optional: `check` - A FHIRPath validation expression  
- Optional: `log` - A FHIRPath logging expression

Currently, FHIRPath expressions can be used in `where`, `check`, and `log`, but the source itself must be a simple property path. There's no way to:
- Transform the source value (e.g., split, substring)
- Derive multiple values from a single source property
- Apply FHIRPath functions to produce the input for a rule

## Stakeholder Perspectives

**Reporter (Brian Postlethwaite):** Has a concrete use case from Michael Lawley requiring splitting a comma-separated field into multiple codings. Points to Zulip discussion for context.

**Zulip Discussion Context:**
From the "fhirpath expressions as source" thread:
- Brian and Michael Lawley explored workarounds using target variables
- Found issues with target variables not supporting collections
- The specification hints that target variables can be used as sources, but implementation doesn't fully support this

## Related Issues & Discussions

- **FHIR-54473** (Triaged): "FHIR Mapping Language not ready for normative" - Parent concern about FML maturity
- **FHIR-46548** (Applied): "Clarify the context of fhirpath expressions" - Related FHIRPath context clarification

**Zulip (#FHIR Mapping Language):**
- [fhirpath expressions as source](https://chat.fhir.org/#narrow/channel/379173-FHIR-Mapping-Language/topic/fhirpath.20expressions.20as.20source/with/533218712) - 4 messages discussing this specific need

## Technical Considerations

1. **Current Workaround Limitations**:
   - Can create target variables and try to use them as sources
   - But: "target variables don't support having more than 1 value"
   - The spec says "target variables can be treated as source for a group" but implementation is incomplete

2. **Grammar Impact**: The FML grammar would need to change to allow FHIRPath expressions in the source position:
   ```
   // Current: context.element
   src.property as alias
   
   // Proposed: (fhirpath expression)
   (src.property.split(',')) as alias
   ```

3. **StructureMap Representation**: The StructureMap resource's `source` element would need to accommodate FHIRPath expressions, not just property paths.

4. **Collection Handling**: If a FHIRPath expression produces multiple values, each value should drive a separate execution of the rule (consistent with how repeating properties work).

5. **Performance**: FHIRPath expressions in source position would be evaluated during mapping, potentially impacting performance.

6. **Clarity vs Complexity**: Adding FHIRPath to sources increases power but also complexity. Users must understand when a source is a path vs an expression.

## Potential Courses of Action

### Option A: Allow FHIRPath Expressions as Sources
- **Description**: Extend the FML grammar and StructureMap to allow source to be a FHIRPath expression (indicated by parentheses). The expression's result becomes the input for the rule.
- **Pros**:
  - Directly solves the use case
  - Consistent with FHIRPath usage elsewhere in FML
  - Powerful and flexible
- **Cons**:
  - Grammar change
  - StructureMap resource change (potentially breaking)
  - Increased complexity
- **Impact**: Compatible, substantive (if additive to grammar)

### Option B: Enhance Target Variable Support
- **Description**: Fix target variables to support collections and be usable as sources, as the spec suggests should work.
- **Pros**:
  - Uses existing mechanisms
  - May require less grammar change
  - Already partially documented
- **Cons**:
  - Indirect approach (create target, then use as source)
  - More verbose for simple cases
  - Still needs specification clarity
- **Impact**: Bug fix / clarification

### Option C: Add Split-Specific Function
- **Description**: Add a specialized construct for the split use case rather than general FHIRPath expressions.
- **Pros**:
  - Solves immediate use case
  - Simpler than full FHIRPath
  - Easier to implement
- **Cons**:
  - Doesn't address general need
  - May need more constructs later
  - Piecemeal approach
- **Impact**: Compatible, substantive

### Option D: Document Workaround, Defer Feature
- **Description**: Document the target-variable-as-source pattern as the workaround, fix any implementation bugs, and defer the FHIRPath-as-source feature to a future version.
- **Pros**:
  - Lower risk for R6
  - Time to design properly
  - Existing mechanism available
- **Cons**:
  - Use case not fully solved
  - Workaround is awkward
- **Impact**: Documentation/bug fix only

### Option E: Introduce Helper Group Pattern
- **Description**: Document a pattern using helper groups that can transform input before the main mapping logic.
- **Pros**:
  - No language changes
  - Works with current capabilities
- **Cons**:
  - Verbose
  - Not intuitive
  - May not cover all cases
- **Impact**: Documentation only

## Questions for the Workgroup

1. **Use Case Prevalence**: How common is the need to transform source values before mapping? Is split the main case, or are there others?

2. **Target Variable Behavior**: What should the relationship between target variables and source contexts be? Is the current spec/implementation correct?

3. **Grammar Implications**: What would FHIRPath-as-source look like in the grammar? How is it distinguished from property paths?

4. **StructureMap Impact**: Can this be implemented without changing the StructureMap resource structure?

5. **Implementation Readiness**: Are implementations prepared to handle FHIRPath expressions as sources?

6. **Normative Scope**: Is this essential for normative FML, or can it be deferred?

## References

- [FHIR Mapping Language - Source Content](https://build.fhir.org/mapping-language.html#7.8.0.8.1)
- [Jira Issue FHIR-54474](https://jira.hl7.org/browse/FHIR-54474)
- [Zulip Discussion](https://chat.fhir.org/#narrow/channel/379173-FHIR-Mapping-Language/topic/fhirpath.20expressions.20as.20source)
- Section 7.8.0.8.1 of FHIR Core Specification
