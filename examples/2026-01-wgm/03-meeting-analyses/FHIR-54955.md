# FHIR-54955: Rule Evaluation Order Undefined - States to Use first/last to Help Manage Order

## Issue Overview

This issue concerns the FHIR Mapping Language (FML) specification, specifically the handling of list options (`first`, `last`, `only_one`, `not_first`, `not_last`) in source rule evaluation. The specification suggests using these list options to help manage rule evaluation order, but the submitter (Brian Postlethwaite) questions how this actually helps.

The issue also proposes that with the addition of FHIRPath source expression support, a note should be added that these list options could be implemented using equivalent FHIRPath functions:
- `first` → `src.element.first()`
- `not_first` → `src.element.skip(1)`
- `last` → `src.element.last()`

Additionally, the submitter asks for clarification on the difference between `first` and `only_one` - does `only_one` mean the map doesn't care which value is used, or is it a check condition (like FHIRPath's `single()`)?

## Current State

The FHIR Mapping Language specification (Section 7.4.0.8) discusses source list-options that control which elements from a repeating source are processed:

- **first**: Only process the first element
- **last**: Only process the last element  
- **not_first**: Process all elements except the first (skip the first)
- **not_last**: Process all elements except the last
- **only_one**: Process exactly one element (semantics unclear)

There's also a target `list_mode` that has similar values, used to control output behavior.

The spec states that rule evaluation order is undefined and suggests using these list options to manage order, but doesn't explain the mechanism clearly.

## Stakeholder Perspectives

**Brian Postlethwaite** (Reporter):
- Questions the utility of the current guidance: "How does this help?"
- Suggests adding documentation linking list-options to equivalent FHIRPath functions
- Specifically asks for clarification on `only_one` semantics
- Contributor to .NET FHIR SDK and FHIRPath implementation

No additional comments yet on this issue. Limited Zulip discussion found specifically on list-option semantics, though there is active discussion on the FHIR Mapping Language in general.

## Related Issues & Discussions

- [FHIR Mapping Language Specification](https://hl7.org/fhir/6.0.0-ballot4/mapping-language.html)
- [Zulip: FHIR Mapping Language stream](https://chat.fhir.org/#narrow/stream/FHIR%20Mapping%20Language) - Active discussions on FML
- Cross-version mapping work uses FML extensively

## Technical Considerations

1. **FHIRPath Integration**: If FML supports FHIRPath expressions as sources, the list-options become partially redundant - FHIRPath can express the same logic more explicitly.

2. **`only_one` Ambiguity**: Two possible interpretations:
   - "I don't care which one, just give me one" (arbitrary selection)
   - "There should be exactly one, error if not" (validation/assertion)
   
   FHIRPath's `single()` function takes the second interpretation (returns error if not exactly one).

3. **Rule Evaluation Order**: The claim that list-options help with "undefined rule evaluation order" is confusing. List-options control which source elements are selected, not which rules are evaluated in what order.

4. **Target vs Source List Modes**: Both source and target have list modes; the semantics differ and should be clearly distinguished.

5. **Implementation Variance**: Different FML implementations may handle these options differently if the spec is ambiguous.

## Potential Courses of Action

### Option A: Clarify Existing Semantics
- **Description**: Update documentation to clearly define each list-option, including `only_one`, without changing behavior
- **Pros**: Resolves ambiguity; helps implementers align
- **Cons**: May reveal that different implementations interpret these differently
- **Impact**: Non-substantive clarification

### Option B: Add FHIRPath Equivalence Notes
- **Description**: Add documentation showing how list-options map to equivalent FHIRPath expressions (first() → first, skip(1) → not_first, etc.)
- **Pros**: Educational; helps users understand semantics; aids migration to FHIRPath expressions
- **Cons**: Implies FHIRPath is the "canonical" form, which may not be intended
- **Impact**: Non-substantive documentation enhancement

### Option C: Define `only_one` as Validation
- **Description**: Explicitly define `only_one` to require exactly one element (error if more or fewer), equivalent to FHIRPath's `single()`
- **Pros**: Clear semantics; useful for validation scenarios
- **Cons**: May break maps that used `only_one` as "pick any one"
- **Impact**: Potentially breaking if implementations differ

### Option D: Define `only_one` as Arbitrary Selection
- **Description**: Explicitly define `only_one` to select one element arbitrarily when multiple exist (no error)
- **Pros**: Permissive behavior; won't break existing maps
- **Cons**: Less useful for validation; differs from FHIRPath `single()`
- **Impact**: Clarification; may not match all implementations

### Option E: Deprecate List-Options in Favor of FHIRPath
- **Description**: Mark list-options as deprecated; recommend using FHIRPath expressions for element selection
- **Pros**: Simplifies the language; FHIRPath is more powerful and explicit
- **Cons**: Breaking change for existing maps; steeper learning curve
- **Impact**: Non-compatible deprecation

## Questions for the Workgroup

1. What is the intended semantic difference between `first` and `only_one`?

2. Should `only_one` error when multiple elements exist, or silently pick one?

3. Is there value in keeping list-options if FHIRPath expressions can do the same thing more explicitly?

4. What does "use first/last to help manage rule evaluation order" actually mean? Can we provide a concrete example?

5. Are there known implementations we should check for how they currently interpret these options?

## References

- [FHIR-54955 Jira Issue](https://jira.hl7.org/browse/FHIR-54955)
- [FHIR Mapping Language](https://hl7.org/fhir/6.0.0-ballot4/mapping-language.html)
- [FHIR Mapping Language - Section 7.4.0.8](https://hl7.org/fhir/6.0.0-ballot4/mapping-language.html)
- [FHIRPath Functions](https://hl7.org/fhirpath/#functions)
- [Cross-Version Maps](https://build.fhir.org/ig/HL7/fhir-cross-version/)
